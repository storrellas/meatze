<!DOCTYPE html>
<html>

<head>
  <!-- Required meta tags -->
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <!-- Bootstrap CSS -->
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css"
    integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">

  <!-- Font Awesome 4 -->
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css"
    integrity="sha384-wvfXpqpZZVQGK6TAh5PVlGOfQNHSoD2xbE+QkPxCAFlNEevoEH3Sl0sibVcOQVnN" crossorigin="anonymous">

  <!-- Styles -->
  <style type="text/css">
    #chartdiv {
      width: 100%;
      height: 500px;
    }
  </style>

</head>

<body>

    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <a class="navbar-brand" href="#">Navbar</a>
        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>

        <div class="collapse navbar-collapse" id="navbarSupportedContent">
            <ul class="navbar-nav mr-auto">
                <li class="nav-item active">
                    <a class="nav-link" href="/">Home <span class="sr-only">(current)</span></a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="/config/">Config</a>
                </li>
            </ul>
            <form class="form-inline my-2 my-lg-0">
                <input class="form-control mr-sm-2" type="search" placeholder="Search" aria-label="Search">
                <button class="btn btn-outline-success my-2 my-sm-0" type="submit">Search</button>
            </form>
        </div>
    </nav>


  <div class="container">
    <section class="mt-3" style="background-color: #DDDDDD; padding: 10px">
      <div class="row col-md-12 mt-3">
        <h4>Hash Price</h4>
      </div>
      <div class="row mt-3">
        <div class="col-md-6">          
            <div>Price:<span class="ml-3 hash-price"></span></div>
        </div>
        <div>          
          <div>Timestamp:<span class="ml-3 hash-timestamp"></span></div>
        </div>
      </div>
      <div class="row col-md-12 mt-3">
        <h5>
          Data retrieved from <a href="https://hashrateindex.com/coins/bitcoin">https://hashrateindex.com/coins/bitcoin</a> 
        </h5>
      </div>

      
      <div class="row col-md-12 mt-3">
        <h4>asic_scraping_usd_th_effbuckets</h4>
      </div>
      <div class="row mt-3">
        <div class="col-md-6">          
          <div>Under38:<span class="ml-3 under-38"></span></div>
        </div>
        <div>          
          <div>Between38-60:<span class="ml-3 between-38-60"></span></div>
        </div>
      </div>

      <div class="row mt-3">
        <div class="col-md-6">          
          <div>Between60-100:<span class="ml-3 between-60-100"></span></div>
        </div>
        <div>          
          <div>Greater100:<span class="ml-3 greater-100"></span></div>
        </div>
      </div>
    </section>



    <section class="mt-3" style="background-color: #DDDDDD; padding: 10px">
      <div class="row col-md-12 mt-3">
        <h4>Project Configuration</h4>
      </div>
      <hr>
      <div class="row mt-3">
        <div class="col-md-4 input-group mb-3">
          <div class="input-group">
            <input type="number" class="form-control user-input-data" id="project-size" placeholder="Project Size" aria-label="Project Size"
              aria-describedby="basic-addon2">
            <div class="input-group-append">
              <span class="input-group-text" id="basic-addon2">MW</span>
            </div>
          </div>
          <small id="emailHelp" class="form-text text-muted"> "Small description" </small>
        </div>
        <div class="col-md-4 input-group mb-3">
          <div class="input-group">
            <input type="number" class="form-control user-input-data" id="electricity-cost" placeholder="Electricity cost in kwh"
              aria-label="Electricity cost in kwh" aria-describedby="basic-addon2">
            <div class="input-group-append">
              <span class="input-group-text" id="basic-addon2">$/kwh</span>
            </div>
          </div>
          <small id="emailHelp" class="form-text text-muted"> "Small description" </small>
        </div>
        <div class="col-md-4 input-group mb-3">
    
          <div class="input-group">
            <input type="number" class="form-control user-input-data" id="yearly-hours" placeholder="Yearly hours of operation"
              aria-label="Yearly hours of operation" aria-describedby="basic-addon2">
            <div class="input-group-append">
              <span class="input-group-text" id="basic-addon2">hours</span>
            </div>
          </div>
          <small id="emailHelp" class="form-text text-muted"> "Small description" </small>
        </div>
      </div>

      <div class="row">
        <div class="offset-md-3 col-md-6 input-group">
          <div class="input-group">
            <div class="input-group-prepend">
              <label class="input-group-text" for="inputGroupSelect01">Scenario</label>
            </div>
            <select class="custom-select user-input-data" id="scenario-type">
            </select>
          </div>
          <small id="emailHelp" class="form-text text-muted">
              Monthly BTC Price Change / Monthly Hashrate Delta
          </small>

        </div>
      </div>

      <div class="row mt-3">
          <div class="col-md-3">
            <h5>Configuration</h5>
          </div>
      </div>


      <div class="row mt-3">
          <div class="col-md-6 input-group mb-3">
              <div class="input-group mb-3">
                  <div class="input-group-prepend">
                    <label class="input-group-text" for="inputGroupSelect01">Machine Type</label>
                  </div>
                  <select class="custom-select config-input-data" id="machine-type"></select>
                </div>
            <small id="emailHelp" class="form-text text-muted"> "Small description" </small>
          </div>

          <div class="col-md-6 input-group mb-3">
              <div class="input-group mb-3">
                  <div class="input-group-prepend">
                    <label class="input-group-text" for="inputGroupSelect01">Container Type</label>
                  </div>
                  <select class="custom-select config-input-data" id="container-type"></select>
                </div>
            <small id="emailHelp" class="form-text text-muted"> "Small description" </small>
          </div>
        </div>

        <div class="row mt-3 col-md-12">
          <div class="alert alert-primary alert-optimal text-center" role="alert" style="width: 100%">
              
          </div>
        </div>

        <div class="row mt-3">
            <div class="col-md-3">
              <h5>Parameters</h5>
            </div>
        </div>

        <div class="row mt-3">
            <div class="col-md-6 input-group mb-3">
                <div class="input-group">
                  <div class="input-group-prepend">
                    <label class="input-group-text" for="inputGroupSelect01">Market Price USD</label>
                  </div>
                  <input type="text" readonly class="form-control user-input-data" id="market-price-usd" placeholder="Market Price USD"
                    aria-label="Market Price USD" aria-describedby="basic-addon2">
                </div>
                <small id="emailHelp" class="form-text text-muted"> "Small description" </small>
            </div>
  
            <div class="col-md-6 input-group mb-3">
                <div class="input-group">
                  <div class="input-group-prepend">
                    <label class="input-group-text" for="inputGroupSelect01">Hash Rate</label>
                  </div>
                  <input type="text" readonly class="form-control user-input-data" id="hash-rate" placeholder="Hash Rate"
                    aria-label="Hash Rate" aria-describedby="basic-addon2">
                </div>
                <small id="emailHelp" class="form-text text-muted"> "Small description" </small>
            </div>
          </div>

    </section>
    
    
    <section class="mt-3" style="background-color: #DDDDDD; padding: 10px">

      <div class="row col-md-12 mt-3">
        <h4>Project Estimate</h4>
      </div>
      <hr>
     

      <div class="row mt-3">

        <div class="col-md-4">

          <div class="form-group">
              <label for="exampleInputEmail1">CAPEX Server</label>
              <input readonly type="text" class="form-control" id="capex-server" aria-describedby="capex-server"
                placeholder="CAPEX Server">
          </div>
          <div class="form-group">
            <label for="exampleInputEmail1">CAPEX Total</label>
            <input readonly type="text" class="form-control" id="capex-total" aria-describedby="capex-total"
              placeholder="CAPEX Total">
          </div>
          <div class="form-group">
            <label for="exampleInputEmail1">Monthly OPEX</label>
            <input readonly type="text" class="form-control" id="opex-monthly" aria-describedby="emailHelp"
              placeholder="Monthly OPEX">
          </div>
          <div class="form-group">
              <label for="exampleInputEmail1">Expected PBP</label>
              <input readonly type="text" class="form-control" id="pbp" aria-describedby="emailHelp"
                placeholder="Expected PBP">
              <div class="alert alert-pbp alert-danger invisible" role="alert">Configuration non-profitable</div>
          </div>
        </div>
        <div class="col-md-8">
          <div id="chartdiv"></div>
        </div>
      </div>

      <div class="row col-md-12 mt-3">
        <h4>Project Simulation</h4>
      </div>
      <hr>
      <div class="row col-md-12">

        <table id="result-table" class="table" style="background-color: #F5F5F5	">
          <thead  class="text-center" style="background-color: #282828; color: #DDDDDD">
            <tr>
              <th scope="col">Month</th>
              <th scope="col">Montly Income</th>
              <th scope="col">Monthly OPEX</th>
              <th scope="col">Accumulated Monthly Income</th>              
            </tr>
          </thead>
          <tbody class="text-center">
            <tr>
              <td colspan="4">
                </span><i class="spinner ml-3 fa fa-2x fa-spinner fa-spin" aria-hidden="true"></i>
              </td>
            </tr>
          </tbody>
        </table>

      </div>

    </section>

  </div>

  <!-- jQuery first, then Popper.js, then Bootstrap JS -->
  <script src="https://code.jquery.com/jquery-3.5.1.min.js" type="text/javascript"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js"
    integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q"
    crossorigin="anonymous"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js"
    integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl"
    crossorigin="anonymous"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/0.19.2/axios.min.js" type="text/javascript"></script>

  <!-- AM4 Charting -->
  <script src="https://www.amcharts.com/lib/4/core.js"></script>
  <script src="https://www.amcharts.com/lib/4/charts.js"></script>
  <script src="https://www.amcharts.com/lib/4/themes/animated.js"></script>

  <!-- Project Scripts -->
  <script src="/js/meatze-figures.js"></script>

  <script type="text/javascript">

    // Retrieved blockchain
    let market_price_usd = undefined;
    let hash_rate = undefined;

    const banner_initialising = () => `<span>Initialising </span><i class="spinner ml-3 fa fa-spinner fa-spin" aria-hidden="true"></i></span>`
    const banner_waiting = () => `<span>Please introduce your configuration</span>`
    const banner_calculating = () => `<span>Calculating </span><i class="spinner ml-3 fa fa-spinner fa-spin" aria-hidden="true"></i></span>`
    const banner_results = (machine, container) => `<span>Optimal Configuration: MACHINE=${machine} / CONTAINER=${container}</span>`

    const SCENARIO_LIST = {
      pessimistic  : { market_price_usd_delta: 3,  hash_rate_delta: 6 },
      conservative : { market_price_usd_delta: 5,  hash_rate_delta: 5 },
      slightly     : { market_price_usd_delta: 8,  hash_rate_delta: 5 },
      optimistic    : { market_price_usd_delta: 15, hash_rate_delta: 10 }
    }

    // Meatze Firebase
    const machine_type_list = {}
    const scenario_list = {}
    const container_list = {}
    const base_url = 'https://api.meatze.com'

    const fill_configurations = async () => {

      // Retrieve machines
      let response = await axios.get( base_url + '/api/machine/')
      for(const item of response.data.results){
        machine_type_list[item.name] = {
          uuid: item.uuid,
          consumption: item.consumption,
          hashing: item.hashing,
          price: item.price
        }
      }

      // Retrieve scenarios
      response = await axios.get(base_url + '/api/scenario/')
      for(const item of response.data.results){
        scenario_list[item.name] = {
          uuid: item.uuid,
          hash_rate_delta: item.hash_rate_delta,
          market_price_usd_delta: item.market_price_delta
        }
      }

      // Retrieve containers
      response = await axios.get(base_url + '/api/container/')
      for(const item of response.data.results){
        container_list[item.name] = {
          uuid: item.uuid,
          capex: item.capex,
          factor: item.factor
        }
      }



      $("#machine-type").empty()
      for(const machine in machine_type_list ){ // Iterate on machines
        $("#machine-type").append(new Option(machine, machine));
      }
      $("#container-type").empty()
      for(const container in container_list ){ // Iterate on containers
        $("#container-type").append(new Option(container, container));
      }

      $('#scenario-type').empty()
      for(const scenario in scenario_list ){ // Iterate on containers
        const scenario_first_uppercase = scenario[0].charAt(0).toUpperCase()+scenario.slice(1);
        const scenario_obj = scenario_list[scenario]
        const text = scenario_first_uppercase + " - " + 
                      scenario_obj.market_price_usd_delta + "% / " + 
                      scenario_obj.hash_rate_delta + "%";
        $("#scenario-type").append(new Option(text, scenario));
      }
    }

    const update_select_container = () => {
      $('#container-type').empty()
        for(const container in container_list ){ // Iterate on containers
          // When S9 / LiquidCooled remove LiquidCooled
          if( $('#machine-type').val() == "S9" && container == "Liquid Cooled") continue;
          // Add option
          $("#container-type").append(new Option(container, container));
        }
    }

    // -----
    // Sets the output
    // -----
    const set_output = ( config ) => {


      // Capex Project
      $('#capex-server').val(config.capex_server)
      const capex_project_round = Math.round(config.capex_project * 100) / 100;
      $('#capex-total').val(capex_project_round)

      // Montly OPEX
      $('#opex-monthly').val( config.opex_monthly>0?config.opex_monthly:'' )

      // Expected PBP
      if( config.pbp < 0 ){
        $(".alert-pbp ").removeClass('invisible')
        $('#pbp').val('')
      }else{
        $('#pbp').val(config.pbp)
      }

      // Server / Container
      $('#machine-type').val(config.machine)
      $('#container-type').val(config.container)
      update_select_container()

      // Set results in table
      let row_list = ""
      const template_row = (month, income, opex_monthly, accumulated) => 
                            `<tr>
                            <td>${month}</td>
                            <td>${income}</td>
                            <td>${opex_monthly}</td>
                            <td>${accumulated}</td>
                            </tr>`;
      $('#result-table tbody').empty()
      if(config.pbp !== undefined && config.pbp > 0 ){
        for( let i = 0; i < config.evolution.length; i++){
          const date = new Date();  
          date.setMonth( date.getMonth() + i );  
          const month = date.toLocaleString('en-US', { month: 'long' });
          const row = template_row( month, 
                                      config.evolution[i].income,
                                      config.opex_monthly, 
                                      config.evolution[i].accumulated)          
          row_list +=  row 
          if( i > 12 ){
            row_list += `<tr><td colspan="4" class="text-center">...</td></tr>`
            break;
          }
        }
      }else{
        row_list = '<tr><td colspan="4" class="text-center">Project not profitable</td></tr>'
      }
      $('#result-table tbody').html( row_list )


      // Generate chart data
      const chart_data_list = []
      for(let i = 0; i < config.evolution.length; i++){

        const date = new Date();  // 2009-11-10
        date.setDate(1);
        date.setMonth( date.getMonth() + i );  

        chart_data_list.push( { date:date, value: config.evolution[i].accumulated})
      }


      chart.data = chart_data_list
      //chart.data = generatechartData()
      /**/
    }



    // -----
    // Finds the optimal configuration
    // -----
    const find_optimal_config = async () => {
      
      console.log("------------------")
      console.log(" find_optimal_config ")
      console.log("------------------")

      const project_size = $('#project-size').val()
      const electricity_cost = $('#electricity-cost').val()
      const yearly_operation_hours = $('#yearly-hours').val()
      const scenario_selected = $('#scenario-type').val();
      const scenario = scenario_list[scenario_selected]

      // Retrieve effbuckets
      const body = {
        scenario: scenario.uuid,
        project_size: project_size,
        electricity_cost: electricity_cost,
        yearly_operation_hours: yearly_operation_hours
      }
      const response = await axios.post(base_url + '/api/config/optimal/', body )

      const optimal_config = response.data;
      return optimal_config
    }

    // -----
    // Calculates the output configuration according to the user input
    // and sets the output
    // -----
    const calculate_optimal_output_figures = async () => {
      
      $('.alert-optimal').html( banner_calculating() );

      const optimal_config = await find_optimal_config()
      if( optimal_config === undefined ){
        const optimal_text = `Not found optimal configuration`
        $('.alert-optimal').text(optimal_text)

        $('#capex-server').val('')
        $('#capex-total').val('')
        $('#opex-monthly').val('')
        $('#pbp').val('')
        return;
      }

      // Set optimal text
      $('.alert-optimal').html( banner_results(optimal_config.machine, optimal_config.container) )

      // Set configuration
      $('#machine-type').val( optimal_config.machine )
      $('#container-type').val( optimal_config.container )

      // Set output
      set_output( optimal_config )

    }

    // -----
    // Sets the output configuration according to a given configuration
    // -----
    const calculate_output_figures = async () => {

      // --------------------
      // Config by API
      const project_size = $('#project-size').val()
      const electricity_cost = $('#electricity-cost').val()
      const yearly_operation_hours = $('#yearly-hours').val()
      const scenario_selected = $('#scenario-type').val();
      const machine_selected = $('#machine-type').val();
      const container_selected = $('#container-type').val()

      const scenario = scenario_list[scenario_selected]
      const machine = machine_type_list[machine_selected]
      const container = container_list[container_selected]

      // Retrieve effbuckets
      const body = {
        scenario: scenario.uuid,
        machine: machine.uuid,
        container: container.uuid, 
        project_size: project_size,
        electricity_cost: electricity_cost,
        yearly_operation_hours: yearly_operation_hours
      }
      const response = await axios.post(base_url + '/api/config/', body )

      // Set output
      const selected_config = response.data
      set_output( selected_config )
    }

    const initialise = async () => {


      // Fill machine and container
      $('.alert-optimal').html( banner_initialising() )
      
      await fill_configurations();

      // Fake input
      // $('#project-size').val(5), 
      // $('#electricity-cost').val(0.01), 
      // $('#yearly-hours').val(8600)

      // Genearte configuration
      $('.alert-optimal').html( banner_waiting() );
    }

    let typing_timer;
    const completed_typing_interval = 2000;


    let config_list = []
    $(document).ready( () => {

      // Retrieve effbuckets
      axios({
        url: 'https://hasura-prod.artemis.luxorlabs.dev/v1/graphql',
        method: 'post',
        data: {
          query: `query {
                      asic_scraping_usd_th_effbuckets(order_by: { time: desc }, limit: 1) {
                          under38
                          between38_60
                          between60_100
                          greater100
                      }
                  }`
        }
      }).then((result) => {

        // Get Parameters
        const under38 = result.data.data.asic_scraping_usd_th_effbuckets[0].under38
        const between38_60 = result.data.data.asic_scraping_usd_th_effbuckets[0].between38_60
        const between60_100 = result.data.data.asic_scraping_usd_th_effbuckets[0].between60_100
        const greater100 = result.data.data.asic_scraping_usd_th_effbuckets[0].greater100

        // Set parameters in UI
        $('.under-38').text( under38 )
        $('.between-38-60').text( between38_60 )
        $('.between-60-100').text( between60_100 )
        $('.greater-100').text( greater100 )
        
      });

      // Retrieve hashprices
      axios({
        url: 'https://hasura-prod.artemis.luxorlabs.dev/v1/graphql',
        method: 'post',
        data: {
          query: `query {
                    hashprices(from: 1, interval: "1h", coinSymbol: "BTC"){
                        hashprice
                        timestamp
                        __typename
                    }
                  }`
        }
      }).then((result) => {

        // <div class="hash-price"></div>
        // <div class="hash-timestamp"></div>
        const hash_recent = result.data.data.hashprices[0]
        $('.hash-price').text(hash_recent.hashprice)
        $('.hash-timestamp').text(hash_recent.timestamp)
      });



      // Initialise UI
      initialise()

      // Wait for user to finish typing before searching optimal configuration
      $('.user-input-data').on('keyup', () => {
        clearTimeout(typing_timer);
        typing_timer = setTimeout(calculate_optimal_output_figures, completed_typing_interval);
      })
      $('.user-input-data').on('keydown', () => clearTimeout(typing_timer) );
      $('.config-input-data').on('change', () => calculate_output_figures() )
      $('#machine-type').on('change', () => update_select_container() )
      // -------------------------

    })

    let chart = null;

// -------------------------------------------
    // function generatechartData() {
    //   var chartData = [];
    //   var firstDate = new Date();
    //   firstDate.setDate(firstDate.getDate() - 150);
    //   var visits = -40;
    //   var b = 0.6;
    //   for (var i = 0; i < 150; i++) {
    //     // we create date objects here. In your data, you can have date strings
    //     // and then set format of your dates using chart.dataDateFormat property,
    //     // however when possible, use date objects, as this will speed up chart rendering.
    //     var newDate = new Date(firstDate);
    //     newDate.setDate(newDate.getDate() + i);
    //     if (i > 80) {
    //       b = 0.4;
    //     }
    //     visits += Math.round((Math.random() < b ? 1 : -1) * Math.random() * 10);

    //     chartData.push({
    //       date: newDate,
    //       value: visits
    //     });
    //   }
    //   console.log( chartData )
    //   return chartData;
    // }

// -------------------------------------------

    am4core.ready(function () {

      // Themes begin
      am4core.useTheme(am4themes_animated);
      // Themes end

      // Create chart instance
      chart = am4core.create("chartdiv", am4charts.XYChart);


      // chart_list1 = generatechartData()
      // chart_list2 = generatechartData2()

      // Add data
      //chart.data = generatechartData();
      chart.data = [];


      // Create axes
      var dateAxis = chart.xAxes.push(new am4charts.DateAxis());
      dateAxis.startLocation = 0.5;
      dateAxis.endLocation = 0.5;

      // Create value axis
      var valueAxis = chart.yAxes.push(new am4charts.ValueAxis());

      // Create series
      var series = chart.series.push(new am4charts.LineSeries());
      series.dataFields.valueY = "value";
      series.dataFields.dateX = "date";
      series.strokeWidth = 3;
      series.tooltipText = "{valueY.value}";
      series.fillOpacity = 0.1;

      // Create a range to change stroke for values below 0
      var range = valueAxis.createSeriesRange(series);
      range.value = 0;
      //range.endValue = -1000;
      range.endValue = -1000 * 1000 * 1000 * 1000;
      range.contents.stroke = chart.colors.getIndex(4);
      range.contents.fill = range.contents.stroke;
      range.contents.strokeOpacity = 0.7;
      range.contents.fillOpacity = 0.1;

      // Add cursor
      chart.cursor = new am4charts.XYCursor();
      chart.cursor.xAxis = dateAxis;
      chart.scrollbarX = new am4core.Scrollbar();

      series.tooltip.getFillFromObject = false;
      series.tooltip.adapter.add("x", (x, target) => {

        series.tooltip.background.fill = 
          series.tooltip.tooltipDataItem.valueY < 0?chart.colors.getIndex(4):chart.colors.getIndex(0);

        return x;
      })

    }); // end am4core.ready()
  </script>



</body>

</html>